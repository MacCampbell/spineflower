---
title: "100-genome-align"
author: "Mac Campbell"
date: "8/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```


```{r}
library(tidyverse)
```

## Reference Genome 

How does our reference genome compare to our de novo assembly at this point?     

There is a chromosome-level assembly of Fagopyrum: GCA_002319775.1. Downloading and indexing in ~/genomes/fagopyrum     

I'll align the 187 pop gen samples to it and then see how snp numbers compare. We may need to relax proper pairing, so using picards mark duplicates to remove PCR duplicates without proper pairing..      

Not forgetting to remove the non-target species LG58, LG59, LG64, LG65, LG71, paralogs of course    

java -jar picard.jar MarkDuplicates \          
      I=input.bam \       
      O=marked_duplicates.bam \       
      M=marked_dup_metrics.txt      
      
```{sh, eval=FALSE}
(base) maccamp@farm:~/spineflower/data$ ~/gatk-4.1.9.0/gatk MarkDuplicates I=MC24.sort.bam O=temp.marked.bam M=temp.txt REMOVE_SEQUENCING_DUPLICATES=TRUE
```

(base) maccamp@farm:~/spineflower/data$ samtools flagstat MC24.sort.bam
429380 + 0 in total (QC-passed reads + QC-failed reads)
0 + 0 secondary
244 + 0 supplementary
0 + 0 duplicates
243594 + 0 mapped (56.73% : N/A)
429136 + 0 paired in sequencing
214568 + 0 read1
214568 + 0 read2
235090 + 0 properly paired (54.78% : N/A)
237532 + 0 with itself and mate mapped
5818 + 0 singletons (1.36% : N/A)
2314 + 0 with mate mapped to a different chr
936 + 0 with mate mapped to a different chr (mapQ>=5)
      
(base) maccamp@farm:~/spineflower/data$ samtools flagstat temp.marked.bam 
428660 + 0 in total (QC-passed reads + QC-failed reads)
0 + 0 secondary
244 + 0 supplementary
210096 + 0 duplicates
242874 + 0 mapped (56.66% : N/A)
428416 + 0 paired in sequencing
214208 + 0 read1
214208 + 0 read2
234378 + 0 properly paired (54.71% : N/A)
236812 + 0 with itself and mate mapped
5818 + 0 singletons (1.36% : N/A)
2306 + 0 with mate mapped to a different chr
930 + 0 with mate mapped to a different chr (mapQ>=5)

De novo assembly?

(base) maccamp@farm:~/spineflower/data$ samtools flagstat ../1004_alignments/MC24_sorted_proper_rmdup.bam
164667 + 0 in total (QC-passed reads + QC-failed reads)
0 + 0 secondary
124 + 0 supplementary
0 + 0 duplicates
164667 + 0 mapped (100.00% : N/A)
164543 + 0 paired in sequencing
82187 + 0 read1
82356 + 0 read2
164543 + 0 properly paired (100.00% : N/A)
164543 + 0 with itself and mate mapped
0 + 0 singletons (0.00% : N/A)
0 + 0 with mate mapped to a different chr
0 + 0 with mate mapped to a different chr (mapQ>=5)

Yeah, so we have a lot more mapped reads to the genome. Let's see about the number snps.    

Loop it:

```{sh, eval=FALSE}
srun  -p high -t 6:00:00 ls | grep sort.bam | grep -v "bai" | while read line; do ~/gatk-4.1.9.0/gatk MarkDuplicates I=$line O="`basename $line .sort.bam`".dedup.bam M="`basename $line .sort.bam`".txt REMOVE_SEQUENCING_DUPLICATES=TRUE ; done;

```

Analyze, first by generating bamlist

```{r}
meta<-read_csv("meta/182.csv") %>% mutate(GenomeAlign=paste0("data/",Label,".dedup.bam"))

bamlist<-meta %>% select(GenomeAlign)

write_tsv(bamlist, "bamlists/182-genome.bamlist", col_names=FALSE)
```

Generate outputs. I don't think paralogs are going to do much, but will generate an SFS to see what we get.

```{sh, eval=FALSE}
##Generating SFS
srun -p high -t 48:00:00 --mem=16G --nodes=2 $HOME/angsd/angsd -P 12 -bam bamlists/182-genome.bamlist -doSaf 1 -out outputs/100/with-paralogs -anc $HOME/genomes/fagopyrum/GCA_002319775.1_Ft1.0_genomic.fna.gz -GL 2 -minMapQ 10 -minQ 20 > outputs/100/with-paralogs-saf.stdout 2> outputs/100/with-paralogs-saf.stderr

srun  -p bigmemh --mem-per-cpu=10G --mem=32G -t 12:00:00 $HOME/angsd/misc/realSFS outputs/100/with-paralogs.saf.idx -maxIter 100 -P 1 -fold 1 >  outputs/100/with-paralogs.sfs 2> outputs/100/realSFS.stderr


##Generating Beagle file
srun  -p bigmemh --mem-per-cpu=10G --mem=32G -t 12:00:00 $HOME/angsd/angsd -P 4 -bam bamlists/182-genome.bamlist -out outputs/100/pca -minInd 164 -GL 1 -doGlf 2  -doMajorMinor 1 -doMaf 2 -SNP_pval 1e-6 -minMapQ 10 -minQ 20  > outputs/100/pca.stdout 2> outputs/100/pca.stderr &

srun -p high -t 01:00:00 python $HOME/pcangsd/pcangsd.py -beagle outputs/100/pca.beagle.gz -kinship -admix -o outputs/100/pca-kin -threads 10

srun -p high -t 01:00:00 python $HOME/pcangsd/pcangsd.py -beagle outputs/100/pca.beagle.gz -relate outputs/100/pca-kin.kinship.npy -admix -o outputs/100/pca-relate -threads 10
```



## Wayward samples

I need to find a bunch of samples that have to do with parentage. Plates BMAG058 and BMAG60    

Notes in 1001_sequence/plates/info.txt  BMAG058 is a concatenation of two seperate runs, 58 and 60
AM14-O
AM14-P
AM6-O
AM6-P
GV5-O
GV5-P
Lion12-P
Lion7-O
LM1-10-O
LM1-10-P
LM1-22-O
LM1-22-P
LM2-8-O
LM2-8-P
LM3-12-O
LM3-12-P
LM3-16-O
LM3-16-P
LM4-14-O
LM4-14-P
LM4-16-O
LM4-16-P
LM5-13-O
LM5-13-P
LM5-4-O
LM5-4-P
LM6-9-O
LM6-9-P
Long3-O
Long3-P
POT1-O
POT1-P
SMG2-O
SMG2-P
VCC2-O
VCC2-P

What about in here?
/share/schreierlab/Spineflower/ANGSD_analysis/BMAG060, probably on Berbera
